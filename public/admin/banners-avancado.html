<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Banners v2 (AvanÃ§ado)</title>
  <link rel="stylesheet" href="/admin/admin-modern.css">
  <style>
    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    #syncStatus {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }

    #syncStatus.syncing {
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .banner-editor {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .editor-panel, .preview-panel {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,.06);
    }
    .banner-list-advanced {
      display: grid;
      gap: 12px;
    }
    .banner-item {
      display: grid;
      grid-template-columns: 80px 1fr auto;
      gap: 12px;
      align-items: center;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid #FF8C00;
      cursor: pointer;
      transition: all 0.2s;
    }
    .banner-item:hover {
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,.1);
    }
    .banner-item.active {
      border-left-color: #98D447;
      background: #f0f9ff;
    }
    .banner-img {
      width: 80px;
      height: 60px;
      border-radius: 6px;
      object-fit: cover;
      background: #e0e0e0;
    }
    .banner-info h4 {
      margin: 0;
      font-weight: 600;
    }
    .banner-info p {
      margin: 4px 0 0 0;
      font-size: 0.85rem;
      color: #666;
    }
    .banner-actions {
      display: flex;
      gap: 6px;
    }
    .banner-actions button {
      padding: 6px 12px;
      font-size: 0.85rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-edit {
      background: #667eea;
      color: white;
    }
    .btn-delete {
      background: #f87171;
      color: white;
    }
    .btn-edit:hover {
      background: #764ba2;
    }
    .btn-delete:hover {
      background: #dc2626;
    }
    @media (max-width: 1200px) {
      .banner-editor {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body class="admin-body">
  <aside class="admin-sidebar">
    <div class="sidebar-header">
      <h2>ğŸ›’ Admin Panel</h2>
      <p>Pretinho Variedades</p>
    </div>
    <nav class="sidebar-nav">
      <ul>
        <li><a href="/admin/dashboard.html">ğŸ“Š Dashboard</a></li>
        <li><a href="/admin/produtos.html">ğŸ“¦ Produtos</a></li>
        <li><a href="/admin/pedidos.html">ğŸ›ï¸ Pedidos</a></li>
        <li><a href="/admin/categorias.html">ğŸ“ Categorias</a></li>
        <li><a href="/admin/banners.html" class="active">ğŸ–¼ï¸ Banners</a></li>
        <li><a href="/admin/destaques.html">â­ Destaques</a></li>
        <li><a href="/admin/promocoes.html">ğŸ‰ PromoÃ§Ãµes</a></li>
        <li><a href="/admin/configuracoes.html">âš™ï¸ ConfiguraÃ§Ãµes</a></li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <a href="../public/index.html" target="_blank" class="btn-view-site">ğŸŒ Ver Site</a>
      <button id="logoutBtn" class="btn-logout">ğŸšª Sair</button>
    </div>
  </aside>

  <main class="admin-main">
    <header class="admin-topbar">
      <div class="topbar-left"><h1>Banners (Editor AvanÃ§ado)</h1></div>
      <div class="topbar-right"><span class="admin-user">ğŸ‘¤ Admin</span></div>
    </header>

    <div class="admin-content">
      <div class="banner-editor">
        <!-- PAINEL DE EDIÃ‡ÃƒO -->
        <div class="editor-panel">
          <h3 style="margin-top:0;">âœï¸ Editor</h3>
          <div class="form-group">
            <label>Imagem</label>
            <div style="display: flex; gap: 10px; margin-top: 8px;">
              <input type="text" id="bnImage" placeholder="https://..." style="flex: 1; padding:10px; border:1px solid #ddd; border-radius:6px;">
              <button type="button" id="btnUploadImage" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">ğŸ“¤ Upload</button>
            </div>
            <small style="display:block; margin-top:5px; color:#999;">ğŸ’¡ Cole a URL ou clique em "Upload" para fazer upload de arquivo</small>
          </div>
          <div class="form-group">
            <label>TÃ­tulo</label>
            <input type="text" id="bnTitle" placeholder="TÃ­tulo do banner" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-top:5px;">
          </div>
          <div class="form-group">
            <label>SubtÃ­tulo</label>
            <input type="text" id="bnSubtitle" placeholder="SubtÃ­tulo (opcional)" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-top:5px;">
          </div>
          <div class="form-group">
            <label>Link</label>
            <input type="text" id="bnLink" placeholder="#ofertas ou https://..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-top:5px;">
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
            <div class="form-group">
              <label>Ordem</label>
              <input type="number" id="bnOrder" min="1" value="1" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="bnActive" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
                <option value="true">âœ“ Ativo</option>
                <option value="false">âœ— Inativo</option>
              </select>
            </div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
            <button id="btnSave" class="btn-primary" style="padding:12px; border:none; border-radius:6px; cursor:pointer;">ğŸ’¾ Salvar</button>
            <button id="btnNew" class="btn-secondary" style="padding:12px; border:none; border-radius:6px; cursor:pointer;">â• Novo</button>
          </div>
        </div>

        <!-- PAINEL DE PREVIEW -->
        <div class="preview-panel">
          <h3 style="margin-top:0;">ğŸ“º Preview</h3>
          <div id="previewBanner" style="width:100%; height:250px; background:#000; border-radius:8px; display:flex; align-items:center; justify-content:center; color:#999; overflow:hidden; position:relative;">
            Selecione um banner para preview
          </div>
          <div style="margin-top:15px; padding:12px; background:#f0f9ff; border-radius:6px; border-left:4px solid #667eea;">
            <h4 style="margin:0 0 8px 0;">ğŸ“‹ InformaÃ§Ãµes</h4>
            <div id="infoBox" style="font-size:0.9rem; color:#666;">
              <p>Nenhum banner selecionado</p>
            </div>
          </div>
        </div>
      </div>

      <!-- LISTA DE BANNERS -->
      <h3 style="margin:30px 0 15px 0;">ğŸ¬ Seus Banners</h3>
      <div id="bannerListContainer" class="banner-list-advanced">
        <p style="text-align:center; color:#999; padding:20px;">Carregando banners...</p>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = 'http://localhost:3333';
    let currentId = null;
    let isSyncing = false;

    document.addEventListener('DOMContentLoaded', () => {
      loadBanners();
      document.getElementById('bnImage').addEventListener('dblclick', uploadImage);
      document.getElementById('btnUploadImage').addEventListener('click', uploadImage);
      document.getElementById('btnSave').addEventListener('click', saveBanner);
      document.getElementById('btnNew').addEventListener('click', clearForm);
      document.getElementById('logoutBtn').addEventListener('click', () => window.location.href = 'login.html');
      
      // NotificaÃ§Ã£o visual de sincronizaÃ§Ã£o
      showSyncStatus();
    });

    // ğŸ“Š MOSTRAR STATUS DE SINCRONIZAÃ‡ÃƒO
    function showSyncStatus() {
      const statusDiv = document.createElement('div');
      statusDiv.id = 'syncStatus';
      statusDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        display: none;
        z-index: 9999;
        font-weight: 600;
        animation: slideInRight 0.3s ease;
      `;
      document.body.appendChild(statusDiv);
    }

    function updateSyncStatus(message, type = 'info') {
      const status = document.getElementById('syncStatus');
      if (!status) return;

      const colors = {
        success: '#10b981',
        error: '#ef4444',
        info: '#3b82f6',
        syncing: '#f59e0b'
      };

      status.textContent = message;
      status.style.background = colors[type] || colors.info;
      status.style.color = 'white';
      status.style.display = 'block';

      if (type !== 'syncing') {
        setTimeout(() => {
          status.style.display = 'none';
        }, 3000);
      }
    }

    async function uploadImage() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async () => {
        if (!input.files || input.files.length === 0) return;
        const form = new FormData();
        form.append('file', input.files[0]);
        try {
          updateSyncStatus('ğŸ“¤ Fazendo upload...', 'syncing');
          const resp = await fetch(`${API_BASE}/api/upload`, { 
            method: 'POST', 
            body: form 
          });
          if (!resp.ok) throw new Error('Erro na resposta');
          const data = await resp.json();
          console.log('âœ… Upload sucesso:', data);
          document.getElementById('bnImage').value = data.url;
          updatePreview();
          updateSyncStatus('âœ… Upload realizado!', 'success');
        } catch (e) {
          console.error('âŒ Erro no upload:', e);
          updateSyncStatus('âŒ Erro ao fazer upload', 'error');
        }
      };
      input.click();
    }

    async function loadBanners() {
      try {
        console.log('ğŸ”„ Carregando banners...');
        const resp = await fetch(`${API_BASE}/api/banners`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const list = await resp.json();
        console.log('âœ… Banners carregados:', list);
        
        const container = document.getElementById('bannerListContainer');
        
        if (list.length === 0) {
          container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">Nenhum banner cadastrado. Crie um novo!</p>';
          return;
        }

        container.innerHTML = list.sort((a,b)=> (a.ord||0)-(b.ord||0)).map((b, idx) => {
          const btnEditClick = `javascript:selectBannerById(${b.id})`;
          const btnDeleteClick = `javascript:deleteBanner(${b.id})`;
          return `
            <div class="banner-item ${currentId === b.id ? 'active' : ''}" data-id="${b.id}" onclick="selectBannerById(${b.id})">
              <img src="${b.image?.startsWith('http') ? b.image : API_BASE + b.image}" class="banner-img" onerror="this.style.background='#ddd'">
              <div class="banner-info">
                <h4>${b.title}</h4>
                <p>${b.subtitle || '(sem subtÃ­tulo)'}</p>
                <p>Ordem: ${b.ord || 0} â€¢ ${b.active ? 'âœ“ Ativo' : 'âœ— Inativo'}</p>
              </div>
              <div class="banner-actions">
                <button class="btn-edit" onclick="event.stopPropagation(); selectBannerById(${b.id})">Editar</button>
                <button class="btn-delete" onclick="event.stopPropagation(); deleteBanner(${b.id})">Excluir</button>
              </div>
            </div>
          `;
        }).join('');
        
        console.log('âœ… Lista renderizada');
      } catch (e) {
        console.error('âŒ Erro ao carregar banners:', e);
        document.getElementById('bannerListContainer').innerHTML = `
          <p style="text-align:center; color:#dc3545; padding:20px;">
            Erro ao carregar banners: ${e.message}
          </p>
        `;
      }
    }

    function selectBanner(id, banner) {
      currentId = id;
      document.getElementById('bnImage').value = banner.image || '';
      document.getElementById('bnTitle').value = banner.title || '';
      document.getElementById('bnSubtitle').value = banner.subtitle || '';
      document.getElementById('bnLink').value = banner.link || '';
      document.getElementById('bnOrder').value = banner.ord || 1;
      document.getElementById('bnActive').value = String(!!banner.active);
      updatePreview();
      
      // Atualizar visualmente qual banner estÃ¡ selecionado
      document.querySelectorAll('.banner-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Selecionar o banner item correto
      const bannerItem = document.querySelector(`.banner-item[data-id="${id}"]`);
      if (bannerItem) {
        bannerItem.classList.add('active');
      }
    }

    // Nova funÃ§Ã£o que carrega do servidor
    async function selectBannerById(id) {
      console.log('ğŸ” Selecionando banner:', id);
      try {
        // Carregar banner do servidor para ter dados atualizados
        const resp = await fetch(`${API_BASE}/api/banners`);
        if (!resp.ok) throw new Error('Erro ao buscar banners');
        const list = await resp.json();
        const banner = list.find(b => b.id === id);
        
        if (!banner) {
          console.error('âŒ Banner nÃ£o encontrado');
          alert('Banner nÃ£o encontrado');
          return;
        }
        
        // Agora chama selectBanner com os dados seguros
        currentId = id;
        document.getElementById('bnImage').value = banner.image || '';
        document.getElementById('bnTitle').value = banner.title || '';
        document.getElementById('bnSubtitle').value = banner.subtitle || '';
        document.getElementById('bnLink').value = banner.link || '';
        document.getElementById('bnOrder').value = banner.ord || 1;
        document.getElementById('bnActive').value = String(!!banner.active);
        updatePreview();
        
        // Marcar item como active
        document.querySelectorAll('.banner-item').forEach(item => {
          item.classList.remove('active');
        });
        const bannerItem = document.querySelector(`.banner-item[data-id="${id}"]`);
        if (bannerItem) {
          bannerItem.classList.add('active');
        }
        
        console.log('âœ… Banner selecionado:', banner);
      } catch (e) {
        console.error('âŒ Erro ao selecionar banner:', e);
        alert(`Erro: ${e.message}`);
      }
    }

    function clearForm() {
      currentId = null;
      document.getElementById('bnImage').value = '';
      document.getElementById('bnTitle').value = '';
      document.getElementById('bnSubtitle').value = '';
      document.getElementById('bnLink').value = '';
      document.getElementById('bnOrder').value = 1;
      document.getElementById('bnActive').value = 'true';
      updatePreview();
      // âŒ REMOVIDO: loadBanners() aqui tambÃ©m causava recarga
      // Apenas remove a classe active
      document.querySelectorAll('.banner-item').forEach(item => {
        item.classList.remove('active');
      });
    }

    function updatePreview() {
      const img = document.getElementById('bnImage').value;
      const title = document.getElementById('bnTitle').value;
      const subtitle = document.getElementById('bnSubtitle').value;
      const link = document.getElementById('bnLink').value;
      const preview = document.getElementById('previewBanner');
      const info = document.getElementById('infoBox');

      if (!title) {
        preview.innerHTML = '<div style="color:#999; text-align:center;">Preencha o tÃ­tulo para ver preview</div>';
        info.innerHTML = '<p>Nenhum banner para exibir</p>';
        return;
      }

      preview.style.backgroundImage = img ? `url('${img}')` : 'none';
      preview.style.backgroundSize = 'cover';
      preview.style.backgroundPosition = 'center';
      preview.innerHTML = `
        <div style="text-align:center; color:white; text-shadow:0 2px 10px rgba(0,0,0,0.5); z-index:2;">
          <h2 style="margin:0; font-size:2rem;">${title}</h2>
          <p style="margin:10px 0 0 0; font-size:1.1rem;">${subtitle}</p>
          ${link ? `<a href="${link}" style="display:inline-block; margin-top:15px; padding:10px 20px; background:#FF8C00; color:white; border-radius:6px; text-decoration:none; font-weight:600;">Ver mais</a>` : ''}
        </div>
      `;

      info.innerHTML = `
        <p><strong>TÃ­tulo:</strong> ${title}</p>
        <p><strong>SubtÃ­tulo:</strong> ${subtitle || '(vazio)'}</p>
        <p><strong>Link:</strong> ${link || '(sem link)'}</p>
        <p><strong>Ordem:</strong> ${document.getElementById('bnOrder').value}</p>
        <p><strong>Status:</strong> ${document.getElementById('bnActive').value === 'true' ? 'âœ“ Ativo' : 'âœ— Inativo'}</p>
      `;
    }

    async function saveBanner() {
      const image = document.getElementById('bnImage').value.trim();
      const title = document.getElementById('bnTitle').value.trim();
      const subtitle = document.getElementById('bnSubtitle').value.trim();
      const link = document.getElementById('bnLink').value.trim();
      const ord = Number(document.getElementById('bnOrder').value) || 1;
      const active = document.getElementById('bnActive').value === 'true';

      if (!image || !title) {
        alert('âŒ Informe imagem e tÃ­tulo');
        return;
      }

      try {
        console.log('ğŸ’¾ Salvando banner...', { image, title, subtitle, link, ord, active });
        updateSyncStatus('ğŸ’¾ Salvando banner...', 'syncing');
        
        const method = currentId ? 'PUT' : 'POST';
        const url = currentId ? `${API_BASE}/api/banners/${currentId}` : `${API_BASE}/api/banners`;
        
        const payload = { image, title, subtitle, link, ord, active };
        console.log('ğŸ“¤ Enviando para:', url, payload);
        
        const response = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        console.log('ğŸ“¡ Status resposta:', response.status);

        if (!response.ok) {
          const error = await response.text();
          throw new Error(`HTTP ${response.status}: ${error}`);
        }

        const savedBanner = await response.json();
        console.log('âœ… Banner salvo:', savedBanner);
        
        // Sincronizar imediatamente
        updateSyncStatus('ğŸ”„ Sincronizando...', 'syncing');
        localStorage.setItem('bannersChanged', 'true');
        localStorage.setItem('lastBannersSync', new Date().toISOString());
        
        updateSyncStatus('âœ… Banner salvo!', 'success');
        
        // Limpar formulÃ¡rio
        clearForm();
        
        // Recarregar lista apÃ³s pequeno delay (para ver o novo banner)
        setTimeout(() => {
          loadBanners();
        }, 500);
        
      } catch (e) {
        console.error('âŒ Erro ao salvar:', e);
        alert(`âŒ Erro: ${e.message}`);
        updateSyncStatus('âŒ Erro ao salvar', 'error');
      }
    }

    async function deleteBanner(id) {
      if (!confirm('âŒ Excluir este banner?')) return;
      try {
        updateSyncStatus('ğŸ—‘ï¸ Excluindo banner...', 'syncing');
        
        const response = await fetch(`${API_BASE}/api/banners/${id}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Erro ao excluir');
        
        // ğŸ”„ SINCRONIZAR COM SITE PÃšBLICO
        updateSyncStatus('ğŸ”„ Sincronizando com site pÃºblico...', 'syncing');
        await syncBannersWithPublic();
        
        updateSyncStatus('âœ… Banner excluÃ­do e sincronizado!', 'success');
        if (currentId === id) clearForm();
        
        // Recarregar lista apÃ³s excluir
        setTimeout(() => {
          loadBanners();
        }, 500);
      } catch (e) {
        console.error('âŒ Erro ao excluir:', e);
        updateSyncStatus('âŒ Erro ao excluir banner', 'error');
      }
    }

    // ğŸ”„ SINCRONIZAR BANNERS COM O SITE PÃšBLICO
    async function syncBannersWithPublic() {
      try {
        // Disparar evento no localStorage
        localStorage.setItem('bannersChanged', 'true');
        localStorage.setItem('lastBannersSync', new Date().toISOString());
        
        // Disparar evento de storage para outras abas
        window.dispatchEvent(new StorageEvent('storage', {
          key: 'bannersChanged',
          newValue: 'true',
          oldValue: 'false',
          storageArea: localStorage
        }));
        
        console.log('ğŸ”„ [BANNER SYNC] SincronizaÃ§Ã£o iniciada');
        return true;
      } catch (e) {
        console.error('âŒ Erro ao sincronizar:', e);
        return false;
      }
    }

    // Atualizar preview em tempo real
    ['bnImage', 'bnTitle', 'bnSubtitle', 'bnLink', 'bnOrder', 'bnActive'].forEach(id => {
      document.getElementById(id)?.addEventListener('input', updatePreview);
      document.getElementById(id)?.addEventListener('change', updatePreview);
    });
  </script>
</body>
</html>


