<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste de Integra√ß√£o - Mercado Pretinho</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 30px 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 40px;
        }

        h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 8px;
        }

        .test-section h2 {
            color: #333;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-section p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .output {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .output-line {
            margin-bottom: 5px;
        }

        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }

        .status {
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-weight: 600;
        }

        .status.ok {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .status.error {
            background: #fee2e2;
            color: #7f1d1d;
            border-left: 4px solid #ef4444;
        }

        .status.warning {
            background: #fef3c7;
            color: #78350f;
            border-left: 4px solid #f59e0b;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
        }

        table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        table tr:hover {
            background: #f9fafb;
        }

        .product-item {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            padding: 10px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .product-image {
            width: 80px;
            height: 80px;
            background: #f3f4f6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .product-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .product-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .product-price {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .product-desc {
            color: #6b7280;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üß™ Teste de Integra√ß√£o - Admin ‚Üî Loja P√∫blica</h1>

    <!-- SE√á√ÉO 1: Verificar Servidor -->
    <div class="test-section">
        <h2>üîå 1. Verificar Servidor</h2>
        <p>Verificar se o servidor Node.js est√° rodando em http://localhost:3333</p>
        <div class="button-group">
            <button class="btn-primary" onclick="testServer()">‚úÖ Testar Conex√£o</button>
            <button class="btn-primary" onclick="testAPI()">üì° Testar API</button>
        </div>
        <div id="serverOutput" class="output"></div>
        <div id="serverStatus" class="status" style="display: none;"></div>
    </div>

    <!-- SE√á√ÉO 2: Listar Produtos Atuais -->
    <div class="test-section">
        <h2>üì¶ 2. Produtos Atuais na API</h2>
        <p>Ver todos os produtos cadastrados no servidor</p>
        <div class="button-group">
            <button class="btn-primary" onclick="loadProductsList()">üîÑ Carregar Produtos</button>
            <button class="btn-danger" onclick="deleteAllProducts()">üóëÔ∏è Deletar TODOS (Cuidado!)</button>
        </div>
        <div id="productsOutput" class="output"></div>
        <div id="productsContainer" style="margin-top: 15px;"></div>
    </div>

    <!-- SE√á√ÉO 3: Criar Produto de Teste -->
    <div class="test-section">
        <h2>‚ûï 3. Criar Produto de Teste</h2>
        <p>Crie um produto automaticamente para testar a integra√ß√£o</p>
        <div class="button-group">
            <button class="btn-success" onclick="createTestProduct()">‚ú® Criar Produto Teste</button>
            <button class="btn-primary" onclick="createRealProduct()">üìù Criar Produto Real</button>
        </div>
        <div id="createOutput" class="output"></div>
    </div>

    <!-- SE√á√ÉO 4: Verificar Site P√∫blico -->
    <div class="test-section">
        <h2>üè† 4. Sincronizar com Site P√∫blico</h2>
        <p>Verificar se os produtos aparecem corretamente no site p√∫blico</p>
        <div class="button-group">
            <button class="btn-primary" onclick="compareProducts()">üîç Comparar Admin ‚Üî P√∫blico</button>
            <button class="btn-primary" onclick="window.open('http://localhost:3333/')" target="_blank">üåê Abrir Loja</button>
            <button class="btn-primary" onclick="window.open('http://localhost:3333/admin/produtos.html')" target="_blank">üîß Abrir Admin</button>
        </div>
        <div id="compareOutput" class="output"></div>
    </div>

    <!-- SE√á√ÉO 5: Status Final -->
    <div class="test-section">
        <h2>‚úÖ 5. Status da Integra√ß√£o</h2>
        <p>Resumo do estado do sistema</p>
        <button class="btn-primary" onclick="fullTest()">üöÄ Teste Completo</button>
        <div id="statusOutput" class="output"></div>
    </div>
</div>

<script>
const API_BASE = 'http://localhost:3333';
let log = {
    server: [],
    products: [],
    create: [],
    compare: [],
    status: []
};

function addLog(section, message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const line = `[${timestamp}] ${message}`;
    log[section].push({ message: line, type });
    console.log(`[${section}]`, message);
}

function displayLog(section, elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = log[section]
            .map(item => `<div class="output-line"><span class="${item.type}">${item.message}</span></div>`)
            .join('');
        element.scrollTop = element.scrollHeight;
    }
}

async function testServer() {
    log.server = [];
    addLog('server', 'üöÄ Iniciando teste de servidor...', 'info');
    
    try {
        addLog('server', `üîå Conectando em ${API_BASE}`, 'info');
        const response = await fetch(`${API_BASE}/api/health`);
        
        if (response.ok) {
            const data = await response.json();
            addLog('server', '‚úÖ Servidor respondendo!', 'success');
            addLog('server', `Status: ${data.status}`, 'success');
            addLog('server', `Servi√ßo: ${data.service}`, 'success');
            
            document.getElementById('serverStatus').className = 'status ok';
            document.getElementById('serverStatus').textContent = '‚úÖ Servidor est√° ONLINE';
            document.getElementById('serverStatus').style.display = 'block';
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
    } catch (e) {
        addLog('server', `‚ùå Erro ao conectar: ${e.message}`, 'error');
        document.getElementById('serverStatus').className = 'status error';
        document.getElementById('serverStatus').textContent = '‚ùå Servidor OFFLINE';
        document.getElementById('serverStatus').style.display = 'block';
    }
    
    displayLog('server', 'serverOutput');
}

async function testAPI() {
    log.server = [];
    addLog('server', 'üåê Testando endpoints da API...', 'info');
    
    try {
        // GET /products
        addLog('server', 'üì• GET /api/products', 'info');
        let response = await fetch(`${API_BASE}/api/products`);
        if (response.ok) {
            const products = await response.json();
            addLog('server', `‚úÖ ${products.length} produto(s) encontrado(s)`, 'success');
        } else {
            throw new Error(`Erro GET /products: ${response.status}`);
        }

        // GET /health
        addLog('server', 'üíì GET /api/health', 'info');
        response = await fetch(`${API_BASE}/api/health`);
        if (response.ok) {
            addLog('server', '‚úÖ Health check OK', 'success');
        } else {
            throw new Error(`Erro GET /health: ${response.status}`);
        }

        addLog('server', 'üéâ Todos os endpoints respondendo!', 'success');
        document.getElementById('serverStatus').className = 'status ok';
        document.getElementById('serverStatus').textContent = '‚úÖ API funcionando corretamente';
        document.getElementById('serverStatus').style.display = 'block';
    } catch (e) {
        addLog('server', `‚ùå Erro: ${e.message}`, 'error');
    }
    
    displayLog('server', 'serverOutput');
}

async function loadProductsList() {
    log.products = [];
    addLog('products', 'üì¶ Carregando produtos...', 'info');
    
    try {
        const response = await fetch(`${API_BASE}/api/products`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const products = await response.json();
        addLog('products', `‚úÖ ${products.length} produto(s) encontrado(s)`, 'success');
        
        if (products.length === 0) {
            addLog('products', '‚ö†Ô∏è  Nenhum produto no banco', 'warning');
            document.getElementById('productsContainer').innerHTML = '<p style="color: #f59e0b;"><strong>‚ÑπÔ∏è Nenhum produto cadastrado ainda</strong></p>';
        } else {
            products.forEach((p, i) => {
                addLog('products', `${i + 1}. ${p.name} - R$ ${p.priceCurrent} (${p.active ? 'Ativo' : 'Inativo'})`, 'info');
            });
            
            // Renderizar produtos
            const container = document.getElementById('productsContainer');
            container.innerHTML = products.map(p => `
                <div class="product-item">
                    <div class="product-image">${p.image ? `<img src="${p.image}" onerror="this.textContent='üì∑'">` : 'üì∑'}</div>
                    <div class="product-info">
                        <div class="product-name">${p.name}</div>
                        <div class="product-price">R$ ${Number(p.priceCurrent).toFixed(2)} <span style="color: #6b7280;">(era R$ ${Number(p.priceOld).toFixed(2)})</span></div>
                        <div class="product-desc">${p.description || 'Sem descri√ß√£o'} ‚Ä¢ ${p.active ? '‚úÖ Ativo' : '‚ùå Inativo'}</div>
                    </div>
                </div>
            `).join('');
        }
    } catch (e) {
        addLog('products', `‚ùå Erro: ${e.message}`, 'error');
    }
    
    displayLog('products', 'productsOutput');
}

async function createTestProduct() {
    log.create = [];
    addLog('create', '‚ûï Criando produto de teste...', 'info');
    
    const productData = {
        name: `üß™ Produto Teste ${Date.now()}`,
        description: 'Este √© um produto de teste para verificar a integra√ß√£o',
        category: 'canetas',
        priceOld: 99.90,
        priceCurrent: 49.90,
        discount: 50,
        image: '/assets/img/produto-placeholder.jpg',
        stock: 100,
        active: true
    };
    
    try {
        addLog('create', 'üì® Enviando dados para API...', 'info');
        const response = await fetch(`${API_BASE}/api/products`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(productData)
        });
        
        if (!response.ok) {
            const error = await response.text();
            throw new Error(`HTTP ${response.status}: ${error}`);
        }
        
        const result = await response.json();
        addLog('create', `‚úÖ Produto criado com ID: ${result.id}`, 'success');
        addLog('create', `üìù Nome: ${result.name}`, 'success');
        addLog('create', '‚è≥ Aguarde 2 segundos...', 'warning');
        
        setTimeout(() => {
            addLog('create', 'üîÑ Recarregando lista de produtos...', 'info');
            loadProductsList();
            addLog('create', '‚úÖ Verifique a se√ß√£o "Produtos Atuais" acima!', 'success');
        }, 2000);
        
    } catch (e) {
        addLog('create', `‚ùå Erro: ${e.message}`, 'error');
    }
    
    displayLog('create', 'createOutput');
}

async function createRealProduct() {
    log.create = [];
    addLog('create', 'üìù Abrindo formul√°rio de produto...', 'info');
    window.open('http://localhost:3333/admin/produtos.html', '_blank');
}

async function compareProducts() {
    log.compare = [];
    addLog('compare', 'üîç Comparando produtos Admin ‚Üî P√∫blico...', 'info');
    
    try {
        // Carregar produtos via API
        const response = await fetch(`${API_BASE}/api/products`);
        if (!response.ok) throw new Error(`Erro ao buscar produtos: ${response.status}`);
        const allProducts = await response.json();
        const activeProducts = allProducts.filter(p => p.active);
        
        addLog('compare', `üìä Total no banco: ${allProducts.length}`, 'info');
        addLog('compare', `‚úÖ Ativos (mostrados na loja): ${activeProducts.length}`, 'success');
        addLog('compare', `‚ùå Inativos: ${allProducts.length - activeProducts.length}`, 'warning');
        
        if (activeProducts.length === 0) {
            addLog('compare', '‚ö†Ô∏è  Nenhum produto ativo para mostrar na loja', 'warning');
            addLog('compare', 'üí° Dica: Crie um produto e ative-o no admin', 'info');
        } else {
            addLog('compare', '‚úÖ Produtos aparecem na loja p√∫blica!', 'success');
            activeProducts.slice(0, 5).forEach(p => {
                addLog('compare', `  ‚Ä¢ ${p.name} (R$ ${p.priceCurrent})`, 'info');
            });
            if (activeProducts.length > 5) {
                addLog('compare', `  ... e mais ${activeProducts.length - 5}`, 'info');
            }
        }
        
    } catch (e) {
        addLog('compare', `‚ùå Erro: ${e.message}`, 'error');
    }
    
    displayLog('compare', 'compareOutput');
}

async function fullTest() {
    log.status = [];
    addLog('status', 'üöÄ Iniciando teste completo...', 'info');
    
    try {
        // 1. Servidor
        addLog('status', '1Ô∏è‚É£  Testando servidor...', 'info');
        let response = await fetch(`${API_BASE}/api/health`);
        if (!response.ok) throw new Error('Servidor offline');
        addLog('status', '‚úÖ Servidor OK', 'success');
        
        // 2. API
        addLog('status', '2Ô∏è‚É£  Testando API...', 'info');
        response = await fetch(`${API_BASE}/api/products`);
        if (!response.ok) throw new Error('API n√£o responde');
        const products = await response.json();
        addLog('status', `‚úÖ API OK (${products.length} produtos)`, 'success');
        
        // 3. Admin
        addLog('status', '3Ô∏è‚É£  Testando painel admin...', 'info');
        response = await fetch(`${API_BASE}/admin/produtos.html`);
        if (!response.ok) throw new Error('Admin n√£o carrega');
        addLog('status', '‚úÖ Admin acess√≠vel', 'success');
        
        // 4. Loja P√∫blica
        addLog('status', '4Ô∏è‚É£  Testando loja p√∫blica...', 'info');
        response = await fetch(`${API_BASE}/`);
        if (!response.ok) throw new Error('Loja n√£o carrega');
        addLog('status', '‚úÖ Loja acess√≠vel', 'success');
        
        // 5. Status Final
        const activeProducts = products.filter(p => p.active);
        addLog('status', '', 'info');
        addLog('status', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
        addLog('status', 'üéâ SISTEMA 100% FUNCIONAL!', 'success');
        addLog('status', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
        addLog('status', `üìä Produtos no banco: ${products.length}`, 'info');
        addLog('status', `‚úÖ Produtos ativos (na loja): ${activeProducts.length}`, 'success');
        addLog('status', 'üîÑ Sincroniza√ß√£o: OK', 'success');
        
    } catch (e) {
        addLog('status', `‚ùå Erro: ${e.message}`, 'error');
    }
    
    displayLog('status', 'statusOutput');
}

async function deleteAllProducts() {
    if (!confirm('‚ö†Ô∏è  CUIDADO! Isso vai deletar TODOS os produtos. Tem certeza?')) return;
    if (!confirm('‚ö†Ô∏è  SEGUNDA CONFIRMA√á√ÉO: Realmente quer deletar TUDO?')) return;
    
    log.products = [];
    addLog('products', 'üóëÔ∏è  Deletando todos os produtos...', 'warning');
    
    try {
        const response = await fetch(`${API_BASE}/api/products`);
        const products = await response.json();
        
        for (const product of products) {
            const delResponse = await fetch(`${API_BASE}/api/products/${product.id}`, {
                method: 'DELETE'
            });
            if (delResponse.ok) {
                addLog('products', `‚úÖ Deletado: ${product.name}`, 'success');
            }
        }
        
        addLog('products', `üéâ ${products.length} produto(s) deletado(s)`, 'success');
        setTimeout(() => loadProductsList(), 1000);
        
    } catch (e) {
        addLog('products', `‚ùå Erro: ${e.message}`, 'error');
    }
    
    displayLog('products', 'productsOutput');
}

// Inicializar ao carregar
window.addEventListener('load', () => {
    addLog('status', '‚úÖ P√°gina de testes carregada', 'success');
    addLog('status', 'Clique em qualquer bot√£o para come√ßar...', 'info');
    displayLog('status', 'statusOutput');
});
</script>

</body>
</html>
